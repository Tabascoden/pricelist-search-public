{% extends "base.html" %}
{% block content %}

<style>
  /* –°—Ç–∏–ª–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ */
  .modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(30, 27, 75, 0.4);
    backdrop-filter: blur(4px);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 100;
    opacity: 1;
    transition: opacity 0.2s;
  }
  .modal-overlay.hidden {
    display: none !important;
    opacity: 0;
  }
</style>

<div class="card">
  <div class="cardHeader">
    <div>
      <h2>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞–º–∏</h2>
      <div class="sub">–ó–∞–≥—Ä—É–∂–∞–π—Ç–µ –ø—Ä–∞–π—Å-–ª–∏—Å—Ç—ã (XLSX/CSV) –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ü–µ–Ω.</div>
    </div>
    <div class="right">
      <button class="btn primary" id="btnAddSupplier">+ –î–æ–±–∞–≤–∏—Ç—å –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞</button>
    </div>
  </div>
</div>

<div class="tableWrap">
  <table>
    <thead>
      <tr>
        <th style="width:30%">–ù–∞–∑–≤–∞–Ω–∏–µ</th>
        <th style="width:30%">–ü–æ—Å–ª–µ–¥–Ω–∏–π –ø—Ä–∞–π—Å</th>
        <th style="width:15%">–ü–æ–∑–∏—Ü–∏–π</th>
        <th style="width:15%">–û–±–Ω–æ–≤–ª–µ–Ω–æ</th>
        <th style="width:10%">–î–µ–π—Å—Ç–≤–∏—è</th>
      </tr>
    </thead>
    <tbody id="supplierRows">
      <tr><td colspan="5" style="text-align:center; padding:40px; color:var(--text-muted)">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞...</td></tr>
    </tbody>
  </table>
</div>

<!-- Modal -->
<div id="modal" class="modal-overlay hidden">
  <div class="card" style="width:100%; max-width:400px; margin:0 20px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);">
    <h3 id="modalTitle">–î–æ–±–∞–≤–∏—Ç—å –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞</h3>
    <div style="margin-top:16px;">
      <input class="input" id="supName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä: –ë–ª—ç–∫–±–µ—Ä–∏)">
    </div>
    <div style="margin-top:24px; display:flex; justify-content:flex-end; gap:12px;">
      <button class="btn" onclick="$('modal').classList.add('hidden')">–û—Ç–º–µ–Ω–∞</button>
      <button class="btn primary" id="btnSaveSupplier">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
  async function loadSuppliers(){
    try {
      const r = await fetch("/api/suppliers");
      const j = await r.json();
      const tbody = $("supplierRows");
      tbody.innerHTML = "";

      (j.suppliers || []).forEach(s => {
        const tr = document.createElement("tr");
        const date = s.last_uploaded_at ? new Date(s.last_uploaded_at).toLocaleString('ru-RU') : "‚Äî";
        tr.innerHTML = `
          <td><div style="font-weight:700">${esc(s.name)}</div></td>
          <td><div style="font-size:12px; color:#64748b">${esc(s.last_filename || "–ù–µ—Ç —Ñ–∞–π–ª–∞")}</div></td>
          <td><span class="badge">${s.rows_imported || 0}</span></td>
          <td style="font-size:12px">${date}</td>
          <td>
            <div style="display:flex; gap:8px;">
              <label class="btn" style="height:36px; padding:0 12px; cursor:pointer" title="–ó–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–∞–π—Å">
                üìÅ <input type="file" style="display:none" onchange="uploadPrice(${s.id}, this)">
              </label>
              <button class="btn danger" style="height:36px; padding:0 12px;" onclick="deleteSupplier(${s.id})" title="–£–¥–∞–ª–∏—Ç—å">‚úï</button>
            </div>
          </td>
        `;
        tbody.appendChild(tr);
      });
    } catch(e) {
      console.error("Failed to load suppliers", e);
    }
  }

  $("btnAddSupplier").addEventListener("click", () => {
    $("supName").value = "";
    $("modal").classList.remove("hidden");
    $("supName").focus();
  });

  $("btnSaveSupplier").addEventListener("click", async () => {
    const name = $("supName").value.trim();
    if(!name) return;
    
    try {
      const r = await fetch("/api/suppliers", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({name})
      });
      if(r.ok) {
        $("modal").classList.add("hidden");
        toast("–î–æ–±–∞–≤–ª–µ–Ω–æ", `–ü–æ—Å—Ç–∞–≤—â–∏–∫ ${name} —Å–æ–∑–¥–∞–Ω`);
        loadSuppliers();
      }
    } catch(e) {
      toast("–û—à–∏–±–∫–∞", "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å");
    }
  });

  async function uploadPrice(id, input){
    const file = input.files[0];
    if(!file) return;
    const fd = new FormData();
    fd.append("file", file);
    toast("–ó–∞–≥—Ä—É–∑–∫–∞...", "–ü—Ä–∞–π—Å-–ª–∏—Å—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è");
    try {
      const r = await fetch(`/api/upload/${id}`, {method: "POST", body: fd});
      const j = await r.json();
      if(j.status === "ok"){
        toast("–£—Å–ø–µ—Ö", `–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${j.count || 0} –ø–æ–∑–∏—Ü–∏–π`);
        loadSuppliers();
      } else {
        alert("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: " + (j.details || j.error));
      }
    } catch(e) {
      toast("–û—à–∏–±–∫–∞", "–°–±–æ–π –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ");
    }
    input.value = ""; // –°–±—Ä–æ—Å –¥–ª—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞ —Ç–æ–≥–æ –∂–µ —Ñ–∞–π–ª–∞
  }

  async function deleteSupplier(id){
    if(!confirm("–£–¥–∞–ª–∏—Ç—å –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞ –∏ –≤—Å–µ –µ–≥–æ —Ü–µ–Ω—ã? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.")) return;
    try {
      const r = await fetch(`/api/suppliers/${id}`, {method: "DELETE"});
      if(r.ok) {
        toast("–£–¥–∞–ª–µ–Ω–æ", "–ü–æ—Å—Ç–∞–≤—â–∏–∫ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω");
        loadSuppliers();
      } else {
        const j = await r.json();
        alert(j.details || j.error);
      }
    } catch(e) {
      toast("–û—à–∏–±–∫–∞", "–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å");
    }
  }

  loadSuppliers();
</script>
{% endblock %}
