{% extends "base.html" %}
{% block content %}

<div class="card">
  <div class="cardHeader">
    <div>
      <h2>Поиск продуктов</h2>
      <div class="sub">Сравнивайте цены от всех поставщиков в реальном времени.</div>
    </div>
    <div class="right">
      <a class="btn primary" href="/cart">Перейти в корзину</a>
    </div>
  </div>

  <div class="controls">
    <input class="input" id="q" placeholder="Поиск товара (например: лосось, молоко 3.2%...)" autocomplete="off"/>
    <select class="select" id="supplier">
      <option value="">Все поставщики</option>
    </select>
    <select class="select" id="sort">
      <option value="rank">По релевантности</option>
      <option value="ppu_asc">Цена за кг/л (выгодно)</option>
      <option value="price_asc">Цена за упаковку ↑</option>
      <option value="price_desc">Цена за упаковку ↓</option>
    </select>
    <select class="select" id="limit">
      <option value="30">30 шт.</option>
      <option value="60" selected>60 шт.</option>
      <option value="120">120 шт.</option>
    </select>
    <button class="btn primary" id="btnSearch">Найти</button>
    <button class="btn" id="btnClear">Сбросить</button>
  </div>
</div>

<div class="tableWrap">
  <table>
    <thead>
      <tr>
        <th style="width:40%">Наименование</th>
        <th style="width:20%">Поставщик</th>
        <th style="width:10%">Фасовка</th>
        <th style="width:15%">Цена</th>
        <th style="width:15%">Действие</th>
      </tr>
    </thead>
    <tbody id="rows">
      <tr><td colspan="5" style="text-align:center; padding:40px; color:var(--text-muted)">Загрузка товаров...</td></tr>
    </tbody>
  </table>
</div>

{% endblock %}

{% block scripts %}
<script>
  async function loadSuppliers(){
    try {
      const r = await fetch("/api/suppliers");
      const j = await r.json();
      const sel = $("supplier");
      sel.innerHTML = `<option value="">Все поставщики</option>`;
      (j.suppliers || []).forEach(s => {
        sel.insertAdjacentHTML("beforeend", `<option value="${esc(s.id)}">${esc(s.name)}</option>`);
      });
    } catch(e) {}
  }

  function addToCartFromRow(it){
    const qty = 1;
    const cart = loadCart();
    const key = String(it.id);
    if(cart[key]){
      cart[key].qty += qty;
    } else {
      cart[key] = {
        id: it.id,
        name_raw: it.name_raw,
        unit: it.unit,
        price: Number(it.price),
        supplier_id: it.supplier_id,
        supplier_name: it.supplier_name,
        qty: qty
      };
    }
    saveCart(cart);
    toast("Добавлено", it.name_raw);
  }

  function render(items){
    const tbody = $("rows");
    tbody.innerHTML = "";
    if(!items.length){
      tbody.innerHTML = `<tr><td colspan="5" style="text-align:center; padding:40px; color:var(--text-muted)">Ничего не найдено</td></tr>`;
      return;
    }
    items.forEach(it => {
      const tr = document.createElement("tr");
      
      // Формируем блок цены: если есть PPU, показываем его
      let priceBlock = `<div style="font-weight:700">${fmtPrice(it.price)} ₽</div>`;
      if(it.price_per_unit && it.base_unit){
        priceBlock += `<div style="font-size:11px; color:var(--text-muted)">${fmtPrice(it.price_per_unit)} ₽/${it.base_unit}</div>`;
      }

      tr.innerHTML = `
        <td>
          <div style="font-weight:500">${esc(it.name_raw)}</div>
          ${it.similarity ? `<div style="font-size:10px; color:#94a3b8">Совпадение: ${Math.round(it.similarity*100)}%</div>` : ''}
        </td>
        <td><span class="badge">${esc(it.supplier_name)}</span></td>
        <td>${esc(it.unit || "—")}</td>
        <td class="accent">${priceBlock}</td>
        <td>
          <button class="btn primary" style="height:32px; font-size:12px; padding:0 12px;" data-add="${it.id}">В корзину</button>
        </td>
      `;
      tbody.appendChild(tr);
      tr.querySelector(`[data-add="${it.id}"]`).addEventListener("click", () => addToCartFromRow(it));
    });
  }

  async function doSearch(){
    const q = $("q").value.trim();
    const url = new URL("/search", window.location.origin);
    url.searchParams.set("q", q);
    url.searchParams.set("limit", $("limit").value);
    if($("supplier").value) url.searchParams.set("supplier_id", $("supplier").value);
    url.searchParams.set("sort", $("sort").value);

    const r = await fetch(url);
    const j = await r.json();
    render(j.items || []);
  }

  $("btnSearch").addEventListener("click", doSearch);
  $("q").addEventListener("keydown", (e) => e.key === "Enter" && doSearch());
  $("btnClear").addEventListener("click", () => { $("q").value = ""; doSearch(); });
  $("sort").addEventListener("change", doSearch);

  loadSuppliers();
  doSearch();
</script>
{% endblock %}
