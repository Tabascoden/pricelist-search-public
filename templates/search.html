{% extends "base.html" %}
{% block content %}

<div class="card">
  <div class="cardHeader">
    <div>
      <h2>Поиск</h2>
      <div class="sub">Фильтр по поставщику + сортировка по цене. Добавляй позиции в корзину.</div>
    </div>
    <div class="right">
      <a class="btn" href="/cart">Открыть корзину</a>
    </div>
  </div>

  <div class="controls">
    <input class="input" id="q" placeholder="Например: помидор, сыр, говядина…" autocomplete="off"/>
    <select class="select" id="supplier">
      <option value="">Все поставщики</option>
    </select>
    <select class="select" id="sort">
      <option value="rank" selected>Релевантность</option>
      <option value="price_asc">Цена ↑</option>
      <option value="price_desc">Цена ↓</option>
    </select>
    <select class="select" id="limit">
      <option value="30">Показать 30</option>
      <option value="60" selected>Показать 60</option>
      <option value="120">Показать 120</option>
    </select>
    <button class="btn primary" id="btnSearch">Найти</button>
    <button class="btn" id="btnClear">Сбросить</button>
  </div>

  <div class="sub" id="statusLine" style="margin-top:8px;">Пустой запрос покажет последние позиции.</div>
</div>

<div class="card">
  <div class="cardHeader">
    <div>
      <h3>Результаты</h3>
      <div class="sub" id="countLine">—</div>
    </div>
  </div>

  <div class="tableWrap">
    <table>
      <thead>
        <tr>
          <th style="width:44%">Товар</th>
          <th style="width:18%">Поставщик</th>
          <th style="width:10%">Ед.</th>
          <th style="width:12%">Цена, руб</th>
          <th style="width:16%">В корзину</th>
        </tr>
      </thead>
      <tbody id="rows">
        <tr><td colspan="5" class="sub">Сделай поиск — результаты появятся тут.</td></tr>
      </tbody>
    </table>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
  async function loadSuppliers(){
    try{
      const r = await fetch("/api/suppliers");
      const j = await r.json();
      const sel = $("supplier");
      sel.innerHTML = `<option value="">Все поставщики</option>`;
      for(const s of (j.suppliers || [])){
        sel.insertAdjacentHTML("beforeend", `<option value="${esc(s.id)}">${esc(s.name)}</option>`);
      }
    }catch(e){}
  }

  function addToCartFromRow(it){
    const qtyEl = document.querySelector(`#qty_${it.id}`);
    const qty = Math.max(1, Number(qtyEl?.value || 1) || 1);

    const cart = loadCart();
    const key = String(it.id);
    if(cart[key]){
      cart[key].qty = Number(cart[key].qty || 1) + qty;
    }else{
      cart[key] = {
        id: it.id,
        name_raw: it.name_raw || "",
        unit: it.unit || "",
        price: Number(it.price || 0),
        supplier_id: it.supplier_id || null,
        supplier_name: it.supplier_name || "",
        qty: qty
      };
    }
    saveCart(cart);
    toast("Добавлено в корзину", `${it.name_raw}`);
  }

  function render(items, q){
    const tbody = $("rows");
    tbody.innerHTML = "";

    $("countLine").textContent = q ? `Найдено: ${items.length}` : `Показано: ${items.length}`;
    $("statusLine").textContent = q ? "Готово." : "Список последних позиций.";

    if(!items.length){
      tbody.innerHTML = `<tr><td colspan="5" class="sub">Ничего не найдено</td></tr>`;
      return;
    }

    for(const it of items){
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td data-label="Товар"><b>${esc(it.name_raw)}</b></td>
        <td data-label="Поставщик">${esc(it.supplier_name || "")}</td>
        <td data-label="Ед.">${esc(it.unit || "—")}</td>
        <td data-label="Цена, руб"><b>${esc(fmtPrice(it.price))}</b></td>
        <td data-label="В корзину">
          <div class="tdActions">
            <input class="qty" id="qty_${it.id}" type="number" min="1" value="1"/>
            <button class="btn primary" type="button" data-add="${it.id}">Добавить</button>
          </div>
        </td>
      `;
      tbody.appendChild(tr);

      tr.querySelector(`[data-add="${it.id}"]`).addEventListener("click", ()=> addToCartFromRow(it));
    }
  }

  async function doSearch(){
    const q = $("q").value.trim();
    const limit = $("limit").value || "60";
    const supplier_id = $("supplier").value || "";
    const sort = $("sort").value || "rank";

    $("statusLine").textContent = q ? "Ищем…" : "Показываю…";

    const url = new URL("/search", window.location.origin);
    if(q) url.searchParams.set("q", q);
    url.searchParams.set("limit", limit);
    if(supplier_id) url.searchParams.set("supplier_id", supplier_id);
    if(sort) url.searchParams.set("sort", sort);

    const r = await fetch(url);
    const j = await r.json();
    render(j.items || [], q);
  }

  $("btnSearch").addEventListener("click", doSearch);
  $("btnClear").addEventListener("click", ()=>{
    $("q").value = "";
    $("supplier").value = "";
    $("sort").value = "rank";
    $("limit").value = "60";
    doSearch();
  });
  $("q").addEventListener("keydown", (e)=>{ if(e.key==="Enter") doSearch(); });

  (async ()=>{
    await loadSuppliers();
    doSearch();
  })();
</script>
{% endblock %}
