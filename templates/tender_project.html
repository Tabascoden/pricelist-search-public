{% extends "base.html" %}
{% block content %}

<div class="card" id="tenders-demo">
  <div class="cardHeader">
    <div>
      <h2>Тендеры</h2>
      <div class="sub">Загрузка списка номенклатуры для закупки из файла на странице Тендеры. При нажатии на звездочку активируется поиск по выбранному названию.</div>
    </div>
  </div>

  <div id="tenders-view-list">
    <div class="tableWrap">
      <table>
        <thead>
          <tr>
            <th style="width:120px;">ID</th>
            <th>Название</th>
            <th style="width:160px;">Позиции</th>
            <th style="width:200px;">Действия</th>
          </tr>
        </thead>
        <tbody id="tenders-list-body">
          <tr>
            <td colspan="4" style="text-align:center; padding:40px; color:var(--text-muted)">Загрузка списка...</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <div id="tenders-view-project" class="hidden">
    <div class="tender-topbar">
      <div class="tender-title">
        <div class="h2" id="tenders-project-title">Тендер</div>
        <div class="tender-hint" id="tenders-project-meta"></div>
      </div>

      <div class="tender-actions">
        <div class="tender-dropdown-wrap">
          <button class="btn" id="tenders-pick-suppliers-btn" type="button">Выбрать поставщиков</button>
          <div class="tender-dropdown hidden" id="tenders-suppliers-dropdown">
            <div class="tender-dropdown-header">
              <div class="h3">Выбор поставщиков для сравнения</div>
              <button class="btn" id="tenders-suppliers-close" type="button">Закрыть</button>
            </div>
            <div class="tender-dropdown-controls">
              <label class="tender-control">
                <div class="tender-control-title">Поиск</div>
                <input class="input" id="tenders-suppliers-search" placeholder="Начни вводить название..." />
              </label>
            </div>
            <div class="suppliersList" id="tenders-suppliers-list"></div>
            <div class="suppliersActions">
              <button class="btn" id="tenders-suppliers-clear" type="button">Выбрать все</button>
              <button class="btn primary" id="tenders-suppliers-apply" type="button">Применить</button>
            </div>
          </div>
        </div>
        <button class="btn primary" id="tenders-build-orders-btn">Собрать заказ(ы)</button>
        <button class="btn" id="tenders-export-btn">Экспорт</button>
        <button class="btn danger" id="tenders-delete-btn">Удалить тендер</button>
      </div>
    </div>

    <div id="tenders-selected-suppliers" class="tender-legend"></div>

    <div class="tender-add" style="margin-top:10px;">
      <div class="tender-add-title">Добавить позицию вручную</div>
      <form class="tender-add-form" id="tenders-add-item-form">
        <input class="input" id="tenders-add-name" placeholder="Номенклатура" required />
        <input class="input input-qty" id="tenders-add-qty" type="number" min="0" step="0.001" placeholder="Количество" />
        <select class="input input-unit" id="tenders-add-unit">
          <option value="">Ед.</option>
          <option value="кг">кг</option>
          <option value="г">г</option>
          <option value="л">л</option>
          <option value="мл">мл</option>
        </select>
        <button class="btn" type="submit">Добавить</button>
      </form>
    </div>

    <div class="tender-add" style="margin-top:10px;">
      <div class="tender-add-title">Добавить списком (копипаст из мессенджера)</div>
      <form class="tender-add-form-col" id="tenders-paste-form">
        <textarea class="input" id="tenders-paste-text" rows="7" placeholder="Каждая строка — одна позиция"></textarea>
        <div class="row tender-add-actions">
          <select class="input input-unit" id="tenders-paste-unit">
            <option value="">Ед. по умолчанию</option>
            <option value="кг">кг</option>
            <option value="г">г</option>
            <option value="л">л</option>
            <option value="мл">мл</option>
          </select>
          <button class="btn" type="submit" id="tenders-paste-submit">Добавить списком</button>
        </div>
        <div class="tender-hint">
          Каждая строка — позиция. Поддержка: "Название 10 кг", "Название - 10 кг", "Название↹10↹кг", нумерация "1) ...".
        </div>
      </form>
    </div>

    <div class="tender-grid" id="tenders-grid" style="margin-top:12px;">
      <table id="tenders-project-table"></table>
    </div>

    <div class="card" style="margin-top:14px;">
      <div class="cartTop">
        <div>
          <div class="cartTitle">Корзина</div>
        <div class="cartSub">Зелёная корзина = позиция выбрана в заказ. Звезда — искать по выбранному названию.</div>
        </div>
        <div class="cartActions" id="tenders-cart-actions"></div>
      </div>

      <div id="tenders-cart"></div>
      <div style="margin-top:10px;" id="tenders-totals"></div>
      <div style="margin-top:10px;" id="tenders-orders"></div>
    </div>
  </div>

  <!-- Модалка подбора позиции у конкретного поставщика -->
  <div class="tender-modal hidden" id="tenders-match-modal">
    <div class="tender-modal-body">
      <div class="tender-modal-header">
        <div>
          <div class="h3" id="tenders-match-title">Подбор позиции</div>
          <div class="tender-hint" id="tenders-match-sub"></div>
        </div>
        <button class="btn" id="tenders-match-close">Закрыть</button>
      </div>

      <div class="tender-hint" style="margin-top:6px;">
        Сортировка: по похожести ↓, затем по цене ↑. Всё ниже 0.30 обычно мусор.
      </div>

      <div class="tender-match-search" style="margin-top:10px;">
        <label class="tender-control" style="flex:1 1 260px;">
          <div class="tender-control-title">Ручной поиск</div>
          <input class="input" id="tenders-match-search" placeholder="Например: филе куриное охлаждённое" />
        </label>
        <button class="btn" id="tenders-match-search-btn" type="button">Найти</button>
      </div>

      <div style="margin-top:10px;">
        <table class="tender-offers-table" style="width:100%;">
          <thead>
            <tr>
              <th>Товар у поставщика</th>
              <th style="width:90px;">Ед.</th>
              <th style="width:140px;">Цена поставщика</th>
              <th style="width:140px;">Цена/ед.</th>
              <th style="width:120px;">Действие</th>
            </tr>
          </thead>
          <tbody id="tenders-match-body"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<style>
  #tenders-demo .hidden { display:none !important; }
  #tenders-demo .tender-form { display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end; }
  #tenders-demo .tender-actions-row { display:flex; gap:8px; }
  #tenders-demo .tender-upload-btn { position: relative; overflow: hidden; }
  #tenders-demo .tender-upload-btn input[type="file"] { position: absolute; inset: 0; opacity: 0; cursor: pointer; }
  #tenders-demo .tender-actions-row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  #tenders-demo .tender-topbar { display:flex; gap:14px; align-items:flex-start; justify-content:space-between; flex-wrap:wrap; }
  #tenders-demo .tender-title { flex: 1 1 auto; min-width: 240px; }
  #tenders-demo .h2 { font-size: 20px; font-weight: 800; }
  #tenders-demo .h3 { font-size: 16px; font-weight: 800; }
  #tenders-demo .tender-actions { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
  #tenders-demo .tender-hint { color:#64748b; font-size: 13px; }
  #tenders-demo .tender-grid { width:100%; overflow:auto; scrollbar-gutter: stable both-edges; position: relative; }
  #tenders-demo .tender-grid table { width:100%; border-collapse: collapse; }
  #tenders-demo .tender-grid th, #tenders-demo .tender-grid td { border-bottom: 1px solid #e2e8f0; padding: 10px; vertical-align: top; }
  #tenders-demo .tender-grid thead th { position: sticky; top: 0; background: #f8fafc; z-index: 10; font-size:12px; text-transform: uppercase; color:#475569; }
  #tenders-demo .tender-grid .sticky-col-1,
  #tenders-demo .tender-grid .sticky-col-2 { position: sticky; background: #fff; }
  #tenders-demo .tender-grid .sticky-col-1 { left: 0; z-index: 10; min-width:70px; width:70px; }
  #tenders-demo .tender-grid .sticky-col-2 { left: 70px; z-index: 9; min-width:130px; box-shadow: 1px 0 0 #e2e8f0; }
  #tenders-demo .tender-grid thead th.sticky-col-1,
  #tenders-demo .tender-grid thead th.sticky-col-2 { z-index: 11; background: #f8fafc; }
  #tenders-demo .tender-dropdown-wrap { position: relative; }
  #tenders-demo .tender-dropdown { position: absolute; top: calc(100% + 8px); right: 0; width: 420px; background: #fff; border: 1px solid #e2e8f0; border-radius: 14px; box-shadow: 0 16px 30px rgba(15, 23, 42, 0.12); padding: 12px; z-index: 20; }
  #tenders-demo .tender-dropdown-header { display:flex; align-items:center; justify-content:space-between; gap:10px; }
  #tenders-demo .tender-dropdown-controls { margin-top: 8px; }

  #tenders-demo .tender-modal { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.5); display:flex; align-items:center; justify-content:center; padding: 20px; z-index: 30; }
  #tenders-demo .tender-modal-body { background: #fff; border-radius: 16px; padding: 16px; max-width: 900px; width: min(900px, 100%); max-height: 85vh; overflow: auto; box-shadow: 0 18px 35px rgba(15, 23, 42, 0.2); }
  #tenders-demo .tender-modal-header { display:flex; align-items:center; justify-content:space-between; gap:12px; }
  #tenders-demo .tender-match-search { display:flex; gap:10px; align-items:flex-end; flex-wrap:wrap; }

  #tenders-demo .supplierTh { width: 260px; min-width:260px; }
  #tenders-demo .supplierCell { width: 260px; min-width:260px; }
  #tenders-demo .supplierCell .supName { font-weight: 700; line-height: 1.25; }
  #tenders-demo .supplierCell .supMeta { margin-top: 4px; display:flex; gap:10px; flex-wrap:wrap; align-items:baseline; }
  #tenders-demo .supplierCell .supPrice { font-weight: 900; }
  #tenders-demo .supplierCell .supScore { color:#64748b; font-size: 12px; }
  #tenders-demo .supplierCell .supEmpty { height: 18px; }
  #tenders-demo .iconRow { display:flex; gap:8px; margin-top: 8px; }
  #tenders-demo .iconBtn { width:28px; height:28px; display:inline-flex; align-items:center; justify-content:center; border:1px solid #e2e8f0; background:white; border-radius:8px; cursor:pointer; }
  #tenders-demo .iconBtn:hover { background:#f8fafc; }
  #tenders-demo .iconBtn:disabled { opacity:.45; cursor:not-allowed; }
  #tenders-demo .iconBtn.star-picked,
  #tenders-demo .iconBtn.cart-picked { background:#22c55e; border-color:#22c55e; color:white; }
  #tenders-demo .iconBtn.star-picked:hover,
  #tenders-demo .iconBtn.cart-picked:hover { background:#16a34a; border-color:#16a34a; }
  #tenders-demo .tender-item-name { display:flex; gap:8px; align-items:center; justify-content:space-between; }
  #tenders-demo .tender-item-delete { border-color:#fecaca; color:#dc2626; }
  #tenders-demo .tender-item-delete:hover { background:#fee2e2; }

  #tenders-demo .supplierCell.picked { background: #ecfdf5; outline: 2px solid #34d399; outline-offset: -2px; border-radius: 10px; }
  #tenders-demo .supplierCell.best:not(.picked) { background: #fffbeb; outline: 2px solid #fbbf24; outline-offset: -2px; border-radius: 10px; }

  #tenders-demo .cartTop { display:flex; gap:12px; align-items:flex-start; justify-content:space-between; flex-wrap:wrap; }
  #tenders-demo .cartTitle { font-weight: 900; }
  #tenders-demo .cartSub { color:#64748b; font-size: 13px; }

  #tenders-demo .cartTable { width:100%; border-collapse: collapse; margin-top: 10px; }
  #tenders-demo .cartTable th, #tenders-demo .cartTable td { border-bottom: 1px solid #e2e8f0; padding: 10px; vertical-align: top; }
  #tenders-demo .cartTable th { background:#f8fafc; font-size: 12px; text-transform: uppercase; color:#475569; }
  #tenders-demo .cartTable .orderQtyInput { width: 110px; padding: 6px 8px; border: 1px solid #e2e8f0; border-radius: 8px; font: inherit; }

  #tenders-demo .totalsGrid { display:grid; grid-template-columns: 1fr; gap:10px; }
  #tenders-demo .totalsGrid table { width:100%; border-collapse: collapse; }
  #tenders-demo .totalsGrid th, #tenders-demo .totalsGrid td { border-bottom: 1px solid #e2e8f0; padding: 10px; vertical-align: top; }
  #tenders-demo .totalsGrid th { background:#f8fafc; font-size: 12px; text-transform: uppercase; color:#475569; }

  #tenders-demo .suppliersList { display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:12px; }
  #tenders-demo .suppliersItem { border:1px solid #e2e8f0; border-radius: 12px; padding: 10px; display:flex; gap:10px; align-items:flex-start; }
  #tenders-demo .suppliersItem input { transform: translateY(2px); }
  #tenders-demo .suppliersActions { display:flex; gap:10px; justify-content:flex-end; margin-top: 12px; }
  #tenders-demo .tender-add { border:1px solid #e2e8f0; border-radius: 12px; padding: 12px; background:#fff; }
  #tenders-demo .tender-add-title { font-weight: 700; margin-bottom: 8px; }
  #tenders-demo .tender-add-form { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
  #tenders-demo .input-qty { width: 70px; }
  #tenders-demo .input-unit { width: 90px; }
  #tenders-demo .tender-add-form-col { display:flex; flex-direction: column; gap: 8px; }
  #tenders-demo .tender-add-form-col .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
  #tenders-demo .tender-add-form-col textarea { width:100%; min-height: 140px; resize: vertical; }
  #tenders-demo .tender-add-actions { justify-content: flex-end; }

  @media (max-width: 880px){
    #tenders-demo .tender-form { width: 100%; justify-content:flex-end; }
    #tenders-demo .tender-file-name { text-align: left; }
    #tenders-demo .tender-dropdown { position: static; width: 100%; box-shadow: none; margin-top: 10px; }
    #tenders-demo .suppliersList { grid-template-columns: 1fr; }
  }
</style>

<script src="/static/tenders.js" defer></script>
{% endblock %}
