{% extends "base.html" %}
{% block content %}
<div class="container">
  <div class="row" style="justify-content:space-between; align-items:center;">
    <div>
      <h1>{{ project.title }}</h1>
      <div class="muted">ID: {{ project.id }} · создан: {{ project.created_at }}</div>
    </div>
    <a class="btn btn-ghost" href="/tenders">← Все тендеры</a>
  </div>

  <div class="card">
    <h2>Загрузка XLSX</h2>
    <div class="row">
      <input type="file" id="file" accept=".xlsx" />
      <button class="btn" id="btn-upload" data-project="{{project.id}}">Загрузить</button>
      <div id="upload-status" class="muted"></div>
    </div>
    <div class="muted">Ожидаемые колонки: Наименование / Количество (единица — опционально).</div>
  </div>

  <div class="card">
    <div class="row" style="justify-content:space-between; align-items:center; gap:12px;">
      <h2 style="margin:0;">Позиции</h2>
      <div class="row" style="gap:8px; align-items:center;">
        <button class="btn btn-ghost" id="btn-autopick" data-project="{{project.id}}">Автоподбор лучших по всем строкам</button>
        <button class="btn btn-ghost" id="btn-export" data-project="{{project.id}}">Экспорт XLSX</button>
      </div>
    </div>
    {% if items|length == 0 %}
      <div class="muted">Пока нет строк. Загрузите XLSX.</div>
    {% else %}
      <table class="table" id="items-table">
        <thead>
          <tr>
            <th>#</th>
            <th>Позиция</th>
            <th>Кол-во</th>
            <th>Выбранное предложение</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          {% for it in items %}
          <tr data-item="{{it.id}}">
            <td class="muted">{{ it.id }}</td>
            <td>{{ it.name_raw }}</td>
            <td>{{ it.qty }} {{ it.unit_raw }}</td>
            <td class="muted chosen">
              {% if it.offer_id %}
                {{ it.supplier_name }} · {{ it.item_name }} · {{ it.price_per_unit }} / баз. ед (score {{ '%.2f'|format(it.score or 0) }})
              {% else %}
                не выбрано
              {% endif %}
            </td>
            <td style="white-space:nowrap;">
              <button class="btn btn-ghost btn-offers" data-project="{{project.id}}" data-item="{{it.id}}">
                Подобрать
              </button>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    {% endif %}
  </div>
</div>

<!-- Modal -->
<div id="offers-modal" class="modal hidden">
  <div class="modal-card">
    <div class="row" style="justify-content:space-between; align-items:center;">
      <h3 style="margin:0;">Варианты поставщиков</h3>
      <button class="btn btn-ghost" id="modal-close">✕</button>
    </div>
    <div id="offers-title" class="muted"></div>
    <div id="offers-body"></div>
  </div>
</div>

<script>
  window.TENDER_PROJECT_ID = {{ project.id }};
</script>
<script src="/static/tenders.js"></script>
{% endblock %}
