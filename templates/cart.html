{% extends "base.html" %}
{% block content %}

<div class="card">
  <div class="cardHeader">
    <div>
      <h2>Корзина закупок</h2>
      <div class="sub" id="cartSummary">Загрузка...</div>
    </div>
    <div class="right">
      <button class="btn danger" id="btnClearCart">Очистить корзину</button>
    </div>
  </div>
</div>

<div class="tableWrap">
  <table>
    <thead>
      <tr>
        <th style="width:40%">Товар</th>
        <th style="width:20%">Поставщик</th>
        <th style="width:10%">Ед.</th>
        <th style="width:10%">Цена</th>
        <th style="width:10%">Кол-во</th>
        <th style="width:10%">Сумма</th>
        <th style="width:5%"></th>
      </tr>
    </thead>
    <tbody id="cartRows">
      <!-- Заполнится JS -->
    </tbody>
  </table>
</div>

<div class="card" style="margin-top: 24px; display: flex; justify-content: flex-end; gap: 12px;">
  <button class="btn" id="btnExportCSV">Экспорт CSV</button>
  <button class="btn primary" id="btnExportXLSX">Скачать Excel (XLSX)</button>
</div>

{% endblock %}

{% block scripts %}
<script>
  function renderCart(){
    const cart = loadCart();
    const tbody = $("cartRows");
    tbody.innerHTML = "";
    
    const items = Object.values(cart);
    let totalSum = 0;

    if(!items.length){
      tbody.innerHTML = `<tr><td colspan="7" style="text-align:center; padding:40px; color:var(--text-muted)">Корзина пуста. Добавьте товары из поиска.</td></tr>`;
      $("cartSummary").textContent = "Пусто";
      return;
    }

    items.sort((a,b) => a.supplier_name.localeCompare(b.supplier_name)).forEach(it => {
      const sum = it.price * it.qty;
      totalSum += sum;
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><div style="font-weight:500">${esc(it.name_raw)}</div></td>
        <td><span class="badge">${esc(it.supplier_name)}</span></td>
        <td>${esc(it.unit)}</td>
        <td>${fmtPrice(it.price)} ₽</td>
        <td>
          <input class="input" type="number" value="${it.qty}" min="1" style="width:70px; height:32px" data-id="${it.id}">
        </td>
        <td class="accent">${fmtPrice(sum)} ₽</td>
        <td>
          <button class="btn" style="color:var(--text-muted); padding:0 8px; height:32px" data-del="${it.id}">✕</button>
        </td>
      `;
      tbody.appendChild(tr);

      tr.querySelector(`input`).addEventListener("change", (e) => {
        const val = Math.max(1, Number(e.target.value) || 1);
        cart[String(it.id)].qty = val;
        saveCart(cart);
        renderCart();
      });

      tr.querySelector(`[data-del="${it.id}"]`).addEventListener("click", () => {
        delete cart[String(it.id)];
        saveCart(cart);
        renderCart();
      });
    });

    $("cartSummary").textContent = `Позиций: ${items.length} | Итого: ${fmtPrice(totalSum)} ₽`;
  }

  $("btnClearCart").addEventListener("click", () => {
    if(confirm("Очистить всю корзину?")){
      saveCart({});
      renderCart();
    }
  });

  async function exportFile(ext){
    const cart = loadCart();
    const items = Object.values(cart);
    if(!items.length) return alert("Корзина пуста");

    const r = await fetch("/export", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({items})
    });
    const blob = await r.blob();
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `zakaz_${new Date().toISOString().slice(0,10)}.${ext}`;
    a.click();
  }

  $("btnExportXLSX").addEventListener("click", () => exportFile("xlsx"));
  $("btnExportCSV").addEventListener("click", () => exportFile("csv"));

  renderCart();
</script>
{% endblock %}
